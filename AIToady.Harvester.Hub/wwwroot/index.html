<!DOCTYPE html>
<html>
<head>
    <title>AI Toady Harvester Hub</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; padding: 20px; height: 100vh; display: flex; flex-direction: column; }
        #grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: minmax(0, calc(50vh - 30px)); gap: 20px; overflow-y: auto; flex: 1; }
        .widget { background: #2a2a2a; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s; overflow: hidden; display: flex; flex-direction: column; }
        .widget:hover { background: #333; }
        .widget.expanded { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; cursor: default; }
        .widget.expanded:hover { background: #2a2a2a; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #dc3545; border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; display: none; }
        .delete-btn { position: absolute; top: 20px; right: 70px; background: #6c757d; border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; }
        .widget.expanded .close-btn, .widget.expanded .delete-btn { display: block; }
        .close-btn:hover { background: #c82333; }
        .delete-btn:hover { background: #5a6268; }
        .widget h2 { font-size: 1.5em; margin-right: 10px; margin-bottom: 0; }
        .status { padding: 8px 12px; border-radius: 4px; font-weight: bold; }
        .status.Harvesting { background: #28a745; }
        .status.Stuck { background: #ffc107; color: #000; }
        .status.Error { background: #dc3545; }
        .status.Idle { background: #6c757d; }
        .logs { background: #1a1a1a; border-radius: 4px; padding: 10px; flex: 1; overflow-y: auto; font-family: monospace; font-size: 0.9em; overflow-x: hidden; word-wrap: break-word; }
        .widget.expanded .logs { max-height: calc(100vh - 100px); }
        .logs div { padding: 4px 0; border-bottom: 1px solid #333; display: flex; gap: 10px; }
        .logs .timestamp { color: #888; min-width: 140px; }
        .logs .message { flex: 1; }
        .logs div:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <h1 style="margin-bottom: 20px;">AI Toady Harvesters</h1>
    <div id="grid"></div>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script>
        const grid = document.getElementById('grid');
        const harvesters = {};

        async function init() {
            const data = await fetch('/api/harvesters').then(r => r.json());
            for (const [id, h] of Object.entries(data)) {
                harvesters[id] = h;
                createWidget(id);
            }

            const conn = new signalR.HubConnectionBuilder().withUrl('/hub').build();
            conn.on('statusUpdate', (id, status) => {
                if (!harvesters[id]) { harvesters[id] = { status: status, logs: [] }; createWidget(id); }
                harvesters[id].status = status;
                updateWidget(id);
            });
            conn.on('logUpdate', (id, logEntry) => {
                if (!harvesters[id]) { harvesters[id] = { status: 'Unknown', logs: [] }; createWidget(id); }
                harvesters[id].logs.unshift(logEntry);
                if (harvesters[id].logs.length > 100) harvesters[id].logs.pop();
                updateWidget(id);
            });
            conn.on('harvesterDeleted', (id) => {
                const widget = document.getElementById(`widget-${id}`);
                if (widget) widget.remove();
                delete harvesters[id];
            });
            await conn.start();
        }

        function createWidget(id) {
            const widget = document.createElement('div');
            widget.className = 'widget';
            widget.id = `widget-${id}`;
            widget.onclick = (e) => {
                if (e.target.classList.contains('close-btn')) {
                    widget.classList.remove('expanded');
                    e.stopPropagation();
                } else if (e.target.classList.contains('delete-btn')) {
                    if (confirm(`Delete ${id}?`)) {
                        fetch(`/api/harvester/${encodeURIComponent(id)}`, { method: 'DELETE' });
                    }
                    e.stopPropagation();
                } else {
                    widget.classList.toggle('expanded');
                }
            };
            grid.appendChild(widget);
            updateWidget(id);
        }

        function updateWidget(id) {
            const h = harvesters[id];
            const widget = document.getElementById(`widget-${id}`);
            widget.innerHTML = `
                <button class="close-btn">&times;</button>
                <button class="delete-btn">&#128465;</button>
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <h2>${id}</h2>
                    <div class="status ${h.status}">${h.status}</div>
                </div>
                <div class="logs">${h.logs.map(l => `<div><span class="timestamp">${l.timestamp || l.Timestamp}</span><span class="message">${l.message || l.Message}</span></div>`).join('')}</div>
            `;
        }

        init();
    </script>
</body>
</html>
