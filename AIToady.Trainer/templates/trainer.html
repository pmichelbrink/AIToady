<!DOCTYPE html>
<html>
<head>
    <title>AI Toady Trainer</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; background: #fff; color: #333; }
        h1 { color: #333; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #fff; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        input, select, button { padding: 10px; font-size: 14px; width: 100%; box-sizing: border-box; background: #fff; color: #333; border: 1px solid #ddd; }
        button { background: #007bff; color: white; border: none; cursor: pointer; margin-top: 10px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .folder-input { display: flex; gap: 10px; margin-bottom: 10px; }
        .folder-input input { flex: 1; }
        .folder-input button { width: auto; padding: 10px 20px; }
        .progress-bar { width: 100%; height: 30px; background: #f0f0f0; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #28a745; transition: width 0.3s; text-align: center; line-height: 30px; color: white; }
        .status-text { margin: 10px 0; color: #666; height: 60px; }
        .status-text span { display: block; margin-top: 5px; word-break: break-all; overflow: hidden; text-overflow: ellipsis; max-height: 40px; }
        #statusView { display: none; }
        
        @media (prefers-color-scheme: dark) {
            body { background: #1e1e1e; color: #e0e0e0; }
            h1 { color: #e0e0e0; }
            .section { border-color: #444; background: #2d2d2d; }
            input, select { background: #3a3a3a; color: #e0e0e0; border-color: #555; }
            .progress-bar { background: #3a3a3a; }
            .status-text { color: #aaa; }
        }
    </style>
</head>
<body>
    <h1><img src="/static/toady.png" alt="AIToady" style="height: 40px; vertical-align: middle; margin-right: 10px;">AI Toady Trainer</h1>
    
    <div id="configView" class="section">
        <h2>Training Configuration</h2>
        
        <label>Vector Database Location:</label>
        <input type="text" id="dbLocation" placeholder="C:\Vector DBs" value="C:\Vector DBs" />
        
        <label>Model Name:</label>
        <input type="text" id="modelName" placeholder="my-custom-model" />
        
        <label>JSON Folders:</label>
        <div id="folderList"></div>
        <button onclick="addFolder()">+ Add Folder</button>
        
        <label>Base Ollama Model:</label>
        <select id="baseModel">
            <option value="">Loading models...</option>
        </select>
        
        <button onclick="startTraining()">Start Training</button>
    </div>
    
    <div id="statusView" class="section">
        <h2>Training Status</h2>
        <div class="status-text">
            <strong>Current File:</strong> <span id="currentFile">-</span>
        </div>
        <div class="status-text">
            <strong>Progress:</strong> <span id="progressText">0 / 0</span>
        </div>
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
        </div>
    </div>

    <script>
        let folders = [];
        
        async function loadModels() {
            const res = await fetch('/models');
            const data = await res.json();
            const select = document.getElementById('baseModel');
            select.innerHTML = data.models.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        
        function addFolder() {
            const div = document.createElement('div');
            div.className = 'folder-input';
            div.innerHTML = `
                <input type="text" placeholder="C:\\path\\to\\json\\files" />
                <button onclick="this.parentElement.remove()">Remove</button>
            `;
            document.getElementById('folderList').appendChild(div);
        }
        
        async function startTraining() {
            const dbLocation = document.getElementById('dbLocation').value.trim();
            const modelName = document.getElementById('modelName').value.trim();
            if (!modelName) {
                alert('Please enter a model name');
                return;
            }
            
            folders = Array.from(document.querySelectorAll('.folder-input input'))
                .map(i => i.value.trim())
                .filter(v => v);
            
            if (folders.length === 0) {
                alert('Please add at least one folder');
                return;
            }
            
            const baseModel = document.getElementById('baseModel').value;
            if (!baseModel) {
                alert('Please select a base model');
                return;
            }
            
            // Save configuration
            localStorage.setItem('trainer_config', JSON.stringify({
                db_location: dbLocation,
                model_name: modelName,
                folders: folders,
                base_model: baseModel
            }));
            
            const res = await fetch('/start_training', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({db_location: dbLocation, model_name: modelName, folders, base_model: baseModel})
            });
            
            const data = await res.json();
            if (data.success) {
                document.getElementById('configView').style.display = 'none';
                document.getElementById('statusView').style.display = 'block';
                pollStatus();
            } else {
                alert('Error: ' + data.error);
            }
        }
        
        async function pollStatus() {
            try {
                const res = await fetch('/status');
                const status = await res.json();
                
                console.log('Status:', status);
                
                document.getElementById('currentFile').textContent = status.current_file || '-';
                document.getElementById('progressText').textContent = `${status.processed} / ${status.total}`;
                document.getElementById('progressFill').style.width = status.progress + '%';
                document.getElementById('progressFill').textContent = status.progress + '%';
                
                if (status.is_training) {
                    setTimeout(pollStatus, 500);
                } else if (status.current_file === 'Complete') {
                    alert('Training complete!');
                }
            } catch (e) {
                console.error('Error polling status:', e);
                setTimeout(pollStatus, 1000);
            }
        }
        
        loadModels();
        
        // Load saved configuration
        const saved = localStorage.getItem('trainer_config');
        if (saved) {
            const config = JSON.parse(saved);
            
            // Restore db location
            if (config.db_location) {
                document.getElementById('dbLocation').value = config.db_location;
            }
            
            // Restore model name
            if (config.model_name) {
                document.getElementById('modelName').value = config.model_name;
            }
            
            // Restore folders
            if (config.folders && config.folders.length > 0) {
                config.folders.forEach(folder => {
                    addFolder();
                    const inputs = document.querySelectorAll('.folder-input input');
                    inputs[inputs.length - 1].value = folder;
                });
            } else {
                addFolder();
            }
            
            // Restore model selection (after models load)
            if (config.base_model) {
                setTimeout(() => {
                    document.getElementById('baseModel').value = config.base_model;
                }, 500);
            }
        } else {
            addFolder();
        }
        
        // Auto-save on page unload
        window.addEventListener('beforeunload', () => {
            const dbLocation = document.getElementById('dbLocation').value.trim();
            const modelName = document.getElementById('modelName').value.trim();
            const folders = Array.from(document.querySelectorAll('.folder-input input'))
                .map(i => i.value.trim())
                .filter(v => v);
            const baseModel = document.getElementById('baseModel').value;
            
            if (dbLocation || modelName || folders.length > 0 || baseModel) {
                localStorage.setItem('trainer_config', JSON.stringify({
                    db_location: dbLocation,
                    model_name: modelName,
                    folders: folders,
                    base_model: baseModel
                }));
            }
        });
    </script>
</body>
</html>